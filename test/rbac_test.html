<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RBAC权限测试</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding: 20px;
        }
        .response {
            max-height: 300px;
            overflow-y: auto;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .token-info {
            font-size: 12px;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">RBAC权限测试工具</h1>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header">登录信息</div>
                    <div class="card-body">
                        <div id="loginStatus" class="alert alert-warning">未登录</div>
                        <div class="token-info mb-2">
                            <strong>Access Token:</strong>
                            <div id="accessTokenValue" class="text-muted">无</div>
                        </div>
                        <div class="token-info">
                            <strong>User ID:</strong>
                            <div id="userIdValue" class="text-muted">无</div>
                        </div>
                        <button id="logoutBtn" class="btn btn-danger btn-sm mt-2" style="display: none;">登出</button>
                    </div>
                </div>
                
                <div class="card mb-3">
                    <div class="card-header">快速登录</div>
                    <div class="card-body">
                        <form id="quickLoginForm">
                            <div class="mb-3">
                                <label for="loginEmail" class="form-label">邮箱</label>
                                <input type="email" class="form-control" id="loginEmail" required>
                            </div>
                            <div class="mb-3">
                                <label for="loginPassword" class="form-label">密码</label>
                                <input type="password" class="form-control" id="loginPassword" required>
                            </div>
                            <button type="submit" class="btn btn-primary">登录</button>
                            <button type="button" id="adminLoginBtn" class="btn btn-warning ms-2">管理员登录</button>
                            <button type="button" id="userLoginBtn" class="btn btn-secondary ms-2">普通用户登录</button>
                        </form>
                    </div>
                </div>
                
                <div class="card mb-3">
                    <div class="card-header">快速注册</div>
                    <div class="card-body">
                        <form id="quickRegisterForm">
                            <div class="mb-3">
                                <label for="regUsername" class="form-label">用户名</label>
                                <input type="text" class="form-control" id="regUsername" required>
                            </div>
                            <div class="mb-3">
                                <label for="regEmail" class="form-label">邮箱</label>
                                <input type="email" class="form-control" id="regEmail" required>
                            </div>
                            <div class="mb-3">
                                <label for="regPassword" class="form-label">密码</label>
                                <input type="password" class="form-control" id="regPassword" required>
                            </div>
                            <button type="submit" class="btn btn-success">注册</button>
                            <button type="button" id="createAdminBtn" class="btn btn-info ms-2">创建管理员</button>
                            <button type="button" id="createUserBtn" class="btn btn-light ms-2">创建普通用户</button>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header">API测试</div>
                    <div class="card-body">
                        <form id="apiTestForm">
                            <div class="mb-3">
                                <label for="apiEndpoint" class="form-label">端点</label>
                                <input type="text" class="form-control" id="apiEndpoint" placeholder="/api/v1/..." required>
                            </div>
                            <div class="mb-3">
                                <label for="apiMethod" class="form-label">方法</label>
                                <select class="form-select" id="apiMethod">
                                    <option value="GET">GET</option>
                                    <option value="POST">POST</option>
                                    <option value="PUT">PUT</option>
                                    <option value="DELETE">DELETE</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="apiPayload" class="form-label">请求体 (JSON)</label>
                                <textarea class="form-control" id="apiPayload" rows="5" placeholder='{"key": "value"}'></textarea>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="useAuth" checked>
                                <label class="form-check-label" for="useAuth">
                                    使用身份认证 (Bearer Token)
                                </label>
                            </div>
                            <button type="submit" class="btn btn-primary">发送请求</button>
                        </form>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">响应</div>
                    <div class="card-body">
                        <div class="response" id="apiResponse">请先发送请求...</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">常用API端点</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <h6>认证API</h6>
                                <ul class="list-group">
                                    <li class="list-group-item api-endpoint" data-endpoint="/api/v1/auth/register" data-method="POST" data-payload='{"username": "test_user", "email": "test@example.com", "password": "password123"}'>注册 POST /auth/register</li>
                                    <li class="list-group-item api-endpoint" data-endpoint="/api/v1/auth/login" data-method="POST" data-payload='{"email": "test@example.com", "password": "password123"}'>登录 POST /auth/login</li>
                                    <li class="list-group-item api-endpoint" data-endpoint="/api/v1/auth/verify" data-method="POST">验证Token POST /auth/verify</li>
                                    <li class="list-group-item api-endpoint" data-endpoint="/api/v1/auth/refresh" data-method="POST">刷新Token POST /auth/refresh</li>
                                    <li class="list-group-item api-endpoint" data-endpoint="/api/v1/auth/logout" data-method="POST">登出 POST /auth/logout</li>
                                </ul>
                            </div>
                            <div class="col-md-3">
                                <h6>用户API</h6>
                                <ul class="list-group">
                                    <li class="list-group-item api-endpoint" data-endpoint="/api/v1/users" data-method="GET">获取用户列表 GET /users</li>
                                    <li class="list-group-item api-endpoint" data-endpoint="/api/v1/users/{id}" data-method="GET">获取单个用户 GET /users/{id}</li>
                                    <li class="list-group-item api-endpoint" data-endpoint="/api/v1/users/{id}" data-method="PUT" data-payload='{"username": "updated_user", "email": "updated@example.com"}'>更新用户 PUT /users/{id}</li>
                                    <li class="list-group-item api-endpoint" data-endpoint="/api/v1/users/{id}" data-method="DELETE">删除用户 DELETE /users/{id}</li>
                                    <li class="list-group-item api-endpoint" data-endpoint="/api/v1/users/{id}/permissions" data-method="GET">获取用户权限 GET /users/{id}/permissions</li>
                                </ul>
                            </div>
                            <div class="col-md-3">
                                <h6>角色API</h6>
                                <ul class="list-group">
                                    <li class="list-group-item api-endpoint" data-endpoint="/api/v1/roles" data-method="GET">获取角色列表 GET /roles</li>
                                    <li class="list-group-item api-endpoint" data-endpoint="/api/v1/roles" data-method="POST" data-payload='{"name": "test_role", "description": "Test role description"}'>创建角色 POST /roles</li>
                                    <li class="list-group-item api-endpoint" data-endpoint="/api/v1/roles/{id}" data-method="GET">获取单个角色 GET /roles/{id}</li>
                                    <li class="list-group-item api-endpoint" data-endpoint="/api/v1/roles/{id}" data-method="PUT" data-payload='{"name": "updated_role", "description": "Updated role description"}'>更新角色 PUT /roles/{id}</li>
                                    <li class="list-group-item api-endpoint" data-endpoint="/api/v1/roles/{id}" data-method="DELETE">删除角色 DELETE /roles/{id}</li>
                                </ul>
                            </div>
                            <div class="col-md-3">
                                <h6>权限API</h6>
                                <ul class="list-group">
                                    <li class="list-group-item api-endpoint" data-endpoint="/api/v1/roles/{id}/permissions" data-method="POST" data-payload='{"permission_id": "permId"}'>分配权限 POST /roles/{id}/permissions</li>
                                    <li class="list-group-item api-endpoint" data-endpoint="/api/v1/roles/{id}/permissions/{permission_id}" data-method="DELETE">移除权限 DELETE /roles/{id}/permissions/{permission_id}</li>
                                    <li class="list-group-item api-endpoint" data-endpoint="/api/v1/users/{id}/roles" data-method="POST" data-payload='{"role_id": "roleId"}'>分配角色 POST /users/{id}/roles</li>
                                    <li class="list-group-item api-endpoint" data-endpoint="/api/v1/users/{id}/roles/{role_id}" data-method="DELETE">移除角色 DELETE /users/{id}/roles/{role_id}</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // API基础URL
        const API_BASE_URL = 'http://localhost:8080';  // 后端服务地址
        
        // 存储Token
        let accessToken = localStorage.getItem('access_token') || null;
        let refreshToken = localStorage.getItem('refresh_token') || null;
        let userId = localStorage.getItem('user_id') || null;
        
        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            updateLoginStatus();
            setupEventHandlers();
        });
        
        // 设置事件处理程序
        function setupEventHandlers() {
            // 快速登录表单
            document.getElementById('quickLoginForm').addEventListener('submit', handleLogin);
            
            // 登录按钮
            document.getElementById('adminLoginBtn').addEventListener('click', () => {
                document.getElementById('loginEmail').value = 'admin@example.com';
                document.getElementById('loginPassword').value = 'admin123';
            });
            
            document.getElementById('userLoginBtn').addEventListener('click', () => {
                document.getElementById('loginEmail').value = 'user@example.com';
                document.getElementById('loginPassword').value = 'user123';
            });
            
            // 快速注册表单
            document.getElementById('quickRegisterForm').addEventListener('submit', handleRegister);
            
            // 注册按钮
            document.getElementById('createAdminBtn').addEventListener('click', () => {
                document.getElementById('regUsername').value = 'admin';
                document.getElementById('regEmail').value = 'admin@example.com';
                document.getElementById('regPassword').value = 'admin123';
            });
            
            document.getElementById('createUserBtn').addEventListener('click', () => {
                document.getElementById('regUsername').value = 'user';
                document.getElementById('regEmail').value = 'user@example.com';
                document.getElementById('regPassword').value = 'user123';
            });
            
            // API测试表单
            document.getElementById('apiTestForm').addEventListener('submit', handleApiTest);
            
            // 登出按钮
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // API端点快捷点击
            document.querySelectorAll('.api-endpoint').forEach(el => {
                el.addEventListener('click', () => {
                    const endpoint = el.dataset.endpoint;
                    const method = el.dataset.method;
                    const payload = el.dataset.payload || '';
                    
                    document.getElementById('apiEndpoint').value = endpoint;
                    document.getElementById('apiMethod').value = method;
                    document.getElementById('apiPayload').value = payload;
                });
            });
        }
        
        // 处理登录
        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/v1/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password, type: 'email' }),
                    credentials: 'include'
                });
                
                const data = await response.json();
                document.getElementById('apiResponse').textContent = JSON.stringify(data, null, 2);
                
                if (response.ok && data.access_token) {
                    accessToken = data.access_token;
                    refreshToken = data.refresh_token;
                    userId = data.user_id;
                    
                    localStorage.setItem('access_token', accessToken);
                    localStorage.setItem('refresh_token', refreshToken);
                    localStorage.setItem('user_id', userId);
                    
                    updateLoginStatus();
                }
            } catch (error) {
                document.getElementById('apiResponse').textContent = `错误: ${error.message}`;
            }
        }
        
        // 处理注册
        async function handleRegister(e) {
            e.preventDefault();
            const username = document.getElementById('regUsername').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/v1/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, email, password }),
                    credentials: 'include'
                });
                
                const data = await response.json();
                document.getElementById('apiResponse').textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                document.getElementById('apiResponse').textContent = `错误: ${error.message}`;
            }
        }
        
        // 处理API测试
        async function handleApiTest(e) {
            e.preventDefault();
            const endpoint = document.getElementById('apiEndpoint').value;
            const method = document.getElementById('apiMethod').value;
            const payloadText = document.getElementById('apiPayload').value;
            const useAuth = document.getElementById('useAuth').checked;
            
            let payload;
            try {
                payload = payloadText ? JSON.parse(payloadText) : null;
            } catch (error) {
                document.getElementById('apiResponse').textContent = `JSON解析错误: ${error.message}`;
                return;
            }
            
            const headers = {
                'Content-Type': 'application/json'
            };
            
            if (useAuth && accessToken) {
                headers['Authorization'] = `Bearer ${accessToken}`;
            }
            
            const options = {
                method,
                headers,
                credentials: 'include'
            };
            
            if (payload && (method === 'POST' || method === 'PUT')) {
                options.body = JSON.stringify(payload);
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
                const data = await response.json();
                document.getElementById('apiResponse').textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                document.getElementById('apiResponse').textContent = `错误: ${error.message}`;
            }
        }
        
        // 处理登出
        async function handleLogout() {
            try {
                const headers = {};
                if (accessToken) {
                    headers['Authorization'] = `Bearer ${accessToken}`;
                }
                
                await fetch(`${API_BASE_URL}/api/v1/auth/logout`, {
                    method: 'POST',
                    headers,
                    credentials: 'include'
                });
                
                accessToken = null;
                refreshToken = null;
                userId = null;
                
                localStorage.removeItem('access_token');
                localStorage.removeItem('refresh_token');
                localStorage.removeItem('user_id');
                
                updateLoginStatus();
                document.getElementById('apiResponse').textContent = '已成功登出';
            } catch (error) {
                document.getElementById('apiResponse').textContent = `登出错误: ${error.message}`;
            }
        }
        
        // 更新登录状态
        function updateLoginStatus() {
            const loginStatus = document.getElementById('loginStatus');
            const accessTokenValue = document.getElementById('accessTokenValue');
            const userIdValue = document.getElementById('userIdValue');
            const logoutBtn = document.getElementById('logoutBtn');
            
            if (accessToken) {
                loginStatus.className = 'alert alert-success';
                loginStatus.textContent = '已登录';
                accessTokenValue.textContent = accessToken;
                userIdValue.textContent = userId || '未知';
                logoutBtn.style.display = 'block';
            } else {
                loginStatus.className = 'alert alert-warning';
                loginStatus.textContent = '未登录';
                accessTokenValue.textContent = '无';
                userIdValue.textContent = '无';
                logoutBtn.style.display = 'none';
            }
        }
    </script>
</body>
</html>
